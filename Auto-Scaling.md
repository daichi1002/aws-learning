# Auto-Scaling

## Auto-Scaling の概要

### Auto Scaling とはなにか？

`インスタンスへのアクセスが高まった時に、新しいインスタンスを増設して、パフォーマンスを向上させる機能`

### スケーリングのタイプ

スケーリングタイプは垂直スケーリングと水平スケーリングの 2 タイプ。Auto-Scaling は水平スケーリング

|          | 垂直スケーリング                              | 水平スケーリング                                    |
| -------- | --------------------------------------------- | --------------------------------------------------- |
| 拡張方法 | スケールアップ：メモリや CPU の追加・増強     | スケールアウト：処理する機器/サーバー台数を増加する |
| 提言方法 | スケールダウン：メモリや CPU の削減・低性能化 | スケールイン：処理する機器/サーバー台数を低減する   |

### グループサイズの設定

グループサイズの設定において、インスタンスの増減値を設定することができる

- 希望する容量
  - Auto Scaling が実行されない状態でのインスタンス数を設定する
  - この数値を変更することで、手動でスケーリングさせることも可能
- 最小キャパシティ
  - スケールイン時にインスタンスを削減する際の下限のインスタンス数を設定する
  - 希望する容量より大きい数値は設定できない
- 最大キャパシティ
  - 最大キャパシティはスケールアウト時に起動するインスタンスの最大数を設定する
  - 希望する容量より少ない数値は設定できない

### スケーリングポリシーの設定

- 動的スケーリング
  - 簡易スケーリングポリシー
    - ターゲット追跡スケーリングポリシーの通常の設定
    - アラーム設定に基づいて 1 段階のスケーリングを実施
  - ステップスケーリングポリシー
    - アラーム超過のサイズに基づいてインスタンス数を動的にスケーリングする 1 つ以上のステップ調整値を指定して複数回の段階的なスケーリングを実施
- 手動スケーリング
  - 希望する容量を調整して、手動でスケーリングを実施する
- スケジュールされたスケーリング
  - スケーリングを実施する日時を指定して、スケーリングを実行する

※スケーリングポリシーの設定は複数組み合わせて設定することが可能

### ヘルスチェック

Auto-Scaling 配下の EC2 のヘルスチェックには EC2 ステータス情報または ELB のヘルスチェックのどちらかを利用する

EC2 ステータス：インスタンスのステータスが running 以外の状態を異常と判断

ELB：ELB のヘルスチェック機能を活用する

### 終了ポリシー

需要減に基づくスケールインの際に、どのインスタンスから終了するかを設定

- デフォルト
  - AZ の選択
    - 複数 AZ にインスタンスがあるか確認し、1 番多いインスタンスが配置されている AZ のインスタンスを削除する
    - 全 AZ が同数のインスタンスが配置されている場合は、ランダムで AZ を選択してインスタンスを削除する
  - インスタンスの選択
    - 起動設定/テンプレートが 1 番古いインスタンスを削除
    - 古いインスタンスが複数ある場合は、次の課金発生が短いインスタンスを削除する
    - 次の課金時間に近いインスタンスが複数ある場合には、ランダムで削除する
- カスタム
  - AZ の選択
    - 複数 AZ にインスタンスがあるか確認し、1 番多いインスタンスが配置されている AZ のインスタンスを削除する
    - 全 AZ で同数のインスタンスが配置されている場合は、ランダムで AZ を選択してインスタンスを削除する
  - インスタンスの選択
    - 選択した AZ のカスタムポリシーに従い削除する

### Auto Scaling の挙動

Auto Scaling が実行されると AZ に適切に分散されるようにインスタンス数が調整される

【基本的な挙動】

- インスタンスが最も少ない AZ でインスタンスを起動する
- インスタンス起動が失敗した場合は、起動が成功するまで別 AZ で起動する

【AZ 間にアンバランスが発生した場合の挙動】

**再分散の実施**

- AZ 間でインスタンス数の不均衡があると調整する
- グループが不均等になった原因のインスタンスを停止して、リソースが不足していた AZ に新規インスタンスを起動する

**再分散時の挙動**

- 古いインスタンスを終了する前に新しいインスタンスを起動することで、パフォーマンス低下を防ぐ
- Auto Scaling の最大容量に近づくと、再分散処理が遅くなったり、完全に停止する可能性がある。これを回避するために、一時的に最大容量を増やす。（最大容量の 10%または+1 の容量を追加する）

### トラブルシューティング

インスタンスのメンテナンスや調査時には Auto Scaling を一時中断して、対応することが必要

**インスタンスの起動失敗**

- Auto Scaling はインスタンスの起動を繰り返し実施し、24 時間失敗し続けると Amazon 側で停止される可能性がある

**インスタンスの障害**

- インスタンスの状態が Impaired になると、数分間リカバリーされるかチェックする
- リカバリーされない場合は新しいインスタンスを起動して、Impaired のインスタンスを終了する

**トラブルシューティングのステップ**

- Auto Scaling グループを一時的に停止せず、インスタンスを停止するなどすると新規インスタンスが起動してします
- Auto Scaling を停止して、調査・復旧し、Auto Scaling を再開することが基本的な実施方法
