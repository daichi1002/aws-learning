# RDS

## RDS の概要

### RDS とはなにか？

`RDSはリレーショナルデータベースをクラウド上で即時に起動して利用することができるサービス`

### RDS の特徴

以下のような標準ソフトウェアを利用したデータベースを構築できる

- MySQL
- ORACLE
- Microsoft SQL Server
- PostgreSQL
- MariaDB
- Amazon Aurora

### RDS のベストプラクティス

- メモリ内に保持できるように十分な RAM を割り当てる
- 拡張モニタリングを使用したオペレーティングシステムの問題の特定
- 特定のメトリクスしきい値に対して Amazon CloudWatch アラームを設定
- MySQL のストレージエンジンには InnoDB を利用する
- 大きなテーブルのパーティションは 16TB を超えないようにする

### ストレージタイプの選択

ストレージタイプは汎用とプロビジョンド IOPS タイプから選択する。マグネティックは古いタイプであり、あまり使用しない。

- 汎用
  - SSD タイプ
  - GB あたりの容量課金を実施
  - 通常のパフォーマンスに加えてバーストを実施し、100~10,000IOPS を実現可能（サイズによって変わる）
- プロビジョンド IOPS
  - SSD タイプ
  - GB あたりの容量課金を実施+プロビジョンド済み IOPS 単位の課金
  - 通常のパフォーマンスに加えてバーストを実施し、1,000~30,000IOPS を実現可能（サイズによって変わる）
- マグネティック
  - ハードディスクタイプ
  - GB あたりの要領課金を実施+IO リクエスト課金
  - 平均 100~最大数百の IOPS

### DB RDS の暗号化

保管時のインスタンスとスナップショットの暗号化が可能

**暗号化対象**

- DB インスタンス
- 自動バックアップ
- リードレプリカ
- スナップショット

**暗号化方式**

- AWS-256 暗号化
- AWS KMS による鍵管理
- リードレプリカも同じ鍵を利用
- `インスタンス作成時にのみ暗号化を設定可能`
- スナップショットのコピーの暗号化/リストア可能

### 自動バックアップ

RDS 側で管理された定期的スナップショット取得を自動で実施する

- 自動でのスナップショット取得とトランザクションログを取得
- 最も適切なデイリーバックアップとトランザクションログを利用して、DB インスタンスを特定の時刻の状態に復元することができる
- バックアップサイクルは「1 日 1 回」で固定されている
- 5 分ごとにトランザクションログのアーカイブを自動で行っており、これにより、ポイントインタイムリカバリが可能となる
- バックアップの保存期間はデフォルト 7 日で最大 35 日まで設定できる
- 増分バックアップを実施する
- RDS のバックアップは AWS が管理する S3 ストレージに保存される
- DB インスタンスを削除した場合や自動バックアップを無効にした場合に、スナップショットは削除される

## RDS のスケールアップ

`データベースのパフォーマンス低下に対してスケーリング対応を実施することが求められる`

### スケーリングのタイプ

スケールアップとスケールアウトを実行して RDS のパフォーマンスを向上させる

|          | 垂直スケーリング                              | 水平スケーリング                                    |
| -------- | --------------------------------------------- | --------------------------------------------------- |
| 拡張方法 | スケールアップ：メモリや CPU の追加・増強     | スケールアウト：処理する機器/サーバー台数を増加する |
| 低減方法 | スケールダウン：メモリや CPU の削除・低性能化 | スケールイン：処理する機器/サーバー台数を低減する   |

### スケールアップ

インスタンスタイプやサイズを変更することでスケールアップによるパフォーマンス向上を実施

- インスタンスサイズの変更
  - 現在の DB インスタンスタイプに対してサイズを高性能なものに変更することで、パフォーマンス向上させる
- インスタンスタイプの変更
  - 現在の DB 利用方式に適した DB インスタンスタイプがある場合は、そのタイプに変更する
- ストレージタイプの変更

  - ストレージタイプを高性能なタイプ（I/O 処理が多い場合は IOPS）に変更する

### インスタンスタイプとサイズ

- インスタンスタイプ
  - インスタンスの得意とする性能領域を決定する
- インスタンスサイズの変更
  - インスタンスのパフォーマンスを決定する

### インスタンスタイプ：汎用

`バランスが取れた対応が可能なMファミリーと、バーストパフォーマンスが提供されるTファミリーが利用可能`

**T2 インスタンス**

汎用バーストパフォーマンスインスタンス。ベースラインレベルの CPU パフォーマンスを提供し、ベースラインを超えてバーストする機能を有する。マイクロサービス、テストおよびステージングデータベースなど、さまざまなデータベースワークロードに適している。

**T3 インスタンス**

T2 と同じく汎用バーストパフォーマンスインスタンス。T3 インスタンスはバランスの取れたコンピューティング、メモリ、およびネットワークのリソースを提供し、使用中に一時的なスパイクが生じる中程度の CPU 使用率をもつデータベースワークロードに適している。

**M4 インスタンス**

バランスの取れたコンピューティング、メモリ、およびネットワークリソースを提供し、オープンソースまたはエンタープライズアプリケーション用の小規模および中規模データベースを含む、さまざまなデータベースワークロードに適している。

**M5 インスタンス**

最新世代の汎用インスタンスで、M4 よりも優れたパフォーマンスを提供する。バランスの取れたコンピューティング、メモリ、およびネットワークのリソースを提供し、さまざまなデータベースワークロードに適している。

### ストレージの容量変更

`ストレージ容量は設定変更で増加させることはできるが、減少させることはできない`

## RDS のスケールアウト

`リードレプリカの増設、キャッシュによる高速化が可能。また全く別DBへと変更するAuroraへの移行も実施可能`

#### リードレプリカの増設

読み込み処理のアクセス集中を分散化するため、読み込み専用インスタンスとなるリードレプリカを増設して、負荷分散する。

#### キャッシュの利用

ElastiCache を連携または、MySQL Memcached 機能を利用してキャッシュを増設し、読み込み処理の高速化を実施する。

#### Aurora への移行

正確にはスケールアウトとは異なるが、RDS MySQL を高性能な Aurora MySQL へと移行することで、性能をアップさせることが可能。

### リードレプリカ

`読み取り専用のレプリカを最大15台設置し、DBの読み取り処理をスケールアウトできる。クロスリージョンでリードレプリカを構成することも可能。`

### RDS の構成比較

マルチ AZ とマルチリージョンと比較してリードレプリカはスケーリングに特化した構成方式となっている。

|              | マルチ AZ 配置                                                                                                            | マルチリージョン配置                                                | リードレプリカ                                                                                                       |
| ------------ | ------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| 目的         | 高可用性                                                                                                                  | 災害復旧とローカルパフォーマンス                                    | スケーラビリティ                                                                                                     |
| 同期方式     | Aurora 以外：同期レプリケーション<br>Aurora：非同期レプリケーション                                                       | 非同期レプリケーション                                              | 非同期レプリケーション                                                                                               |
| アクセス     | Aurora 以外：プライマリインスタンスのみがアクティブ<br>Aurora：全インスタンスがアクティブ                                 | 全てのリージョンにアクセスでき、読み取りに使用できる                | 全てのリードレプリカにアクセス可能で、読み込みのスケーリングに使用可能                                               |
| バックアップ | Aurora 以外：自動バックアップはスタンバイから取得される<br>Aurora：自動バックアップは共有ストレージレイヤーから取得される | 各リージョンで自動バックアップを取得可能                            | デフォルトでバックアップは構成されない                                                                               |
| 配置         | 1 つのリージョン内に常に 2 つ以上のアベイラビリティゾーンを展開                                                           | 各リージョンに対してマルチ AZ 配置が可能                            | アベイラビリティーゾーン内、AZ 間、またはリージョン間に配置可能                                                      |
| 切替         | 問題が検出された場合のスタンバイ（Aurora 以外）またはリードレプリカ（Aurora）への自動フェイルオーバー                     | Aurora は、セカンダリリージョンのプロモーションをマスターに昇格可能 | 手動でスタンドアロンのデータベースインスタンスに昇格可能（Aurora 以外）<br>Aurora はプライマリインスタンスに昇格可能 |

### キャッシュの利用

読込処理の一部をキャッシュとして保持して、高速クエリ処理を実現する構成が可能。

#### ElastiCache の利用

AWS が提供するインメモリ DB サービスである ElastiCache を利用してクエリ処理をインメモリ DB に保持して高速処理を可能にする

#### MySQL オプション機能の利用

MySQL のオプション機能にある Memcached を利用してインメモリキャッシュを利用する
