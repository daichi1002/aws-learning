# ELB

## ELB の概要

### ELB とはなにか

`ELBは複数のEC2インスタンスで処理を可能にするロードバランサーを提供するサービス（トラフィック量を分散するなど）。EC2インスタンスのヘルスチェックを行い、正常なインスタンスのみを利用することも可能になる。`

### ELB の特徴

負荷分散によるスケーラビリティとヘルスチェックによる高可用性を実現

- インスタンス間の負荷を分散するサービス。インスタンスに限らず IP アドレスをターゲットにした負荷分散も可能。
- ヘルスチェックにより以上なインスタンスを認識してトラフィックを正常なインスタンスのみに分散させる。
- パブリックサブネット/プライベートサブネットのどちらでも使用可能。
- 負荷に応じてキャパシティを自動増減するスケーリングを実施するが、これは AWS 側でマネージドサービスとして実施される。
- 時間に応じたロードバランサーキャパシティーユニット（LCU）使用量で課金（CLB のみ転送データ単位）。
- Auto Scaling、Route 53、Cloud Formation などと連携。

### ELB の構成

- ELB を利用したマルチ AZ にインスタンスへのトラフィックを分散する構成が利用される。リージョンを跨げない。
- プライベートサブネットに対してパブリックネットワークと繋がった ELB を構成してトラフィック分散させることも可能。

### ELB のタイプ

現在利用できるロードバランサーは 3 タイプで用途に応じて使い分ける。（主に使われるのは、ALB と NLB）

- **CLB**
  - レイヤー 4 と 7 に対応し、TCP,SSL,HTTP,HTTPS リスナー対応
  - 古いタイプなので ALB/NLB の利用を優先
  - 課金形態がデータ転送（GB 単位）で課金
  - IP アドレスが可変で、DNS のみ利用可能
  - CLB 配下のインスタンスは、すべて同一の機能を持ったインスタンスが必要
  - リクエスト内容を確認して分散先を振り分けるコンテントベースルーティングはできない
- **ALB(Application Load Balancer)**
  - レイヤー 7 に対応し、HTTP/HTTPS リスナー対応
  - パスルーティングが利用可能
  - 時間に応じたロードバランサーキャパシティーユニット（LCU）の使用量で課金
  - IP アドレスが可変で、DNS のみ利用可能
  - デフォルトでクロスゾーン負荷分散が有効
  - 複数ポートを個別のターゲットとして登録することが可能なため、ポートを利用する ECS などのコンテナをロードバランシング可能
  - リクエスト内容を確認して分散先を振り分けるコンテントベースルーティングが可能
  - URL のパスに基づいてルーティングが可能なパスベースルーティングが可能
- **NLB(Network Load Balancer)**
  - 最新のロードバランサーで大規模システムの際に採用される（利用頻度が多いのは ALB）
  - L4 NAT ロードバランサーで TCP リスナーに対応（戻りトラフィックが NLB を経由しない）
  - 時間に応じた LCU の使用量で課金
  - NLB のサブネット拡張サポート（サブネットを追加できる）
  - 固定 IP のため DNS と IP どちらも利用可能
  - ALB よりも高パフォーマンス処理が可能
  - デフォルトでクロスゾーン負荷分散が無効

### ELB の主要機能

- ヘルスチェック
  - EC2 インスタンスの正常/以上を確認し、利用する EC2 の振り分けを行う
- クロスゾーン負荷分散
  - 配下の EC2 の負荷に応じて、複数の AZ にまたがる EC2 インスタンスに均等に負荷分散を行う
- リスナー設定
  - ELB はリスナー設定によって、通信するプロトコルタイプや通信ルールを設定することができる
- 暗号化通信
  - SSL/TSL 証明書を ELB に設定することで HTTPS または TLS 通信を実施することができる
- スティッキーセッション
  - セッションを継続して、同じクライアント端末からのリクエストを継続して同じ EC2 インスタンスに送信する
- Connection Draining
  - インスタンスに異常が発生した場合に、そのバックエンドインスタンスへの指定した秒数の間は通信が切れずに、処理中のリクエストが終わるまで一定時間待ってくれる
