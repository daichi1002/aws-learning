# IAM

## IAM とは

`AWS Identity and Access Management(IAM)は安全にAWS操作を実施するための認証・認可の仕組み`

- AWS アカウント内のユーザーを作成
- AWS リソースへのアクセス権限を管理
- リソース間のアクセス権限を管理
- 一時的なアクセスを許可

## IAM で使われる用語

`IAMリソース`

IAM で保存・管理されるユーザー、グループ、ロール、ポリシー、および ID プロバイダー

`IAMアイデンティティ`

ユーザー、グループ、およびロール。
AWS で認証されてグループ化に使用される IAM リソースオブジェクトのこと。

`IAMエンティティ`

ユーザーおよびロール。AWS に認証される IAM リソースオブジェクト。

`プリンシパル`

ルートユーザー、IAM ユーザー、または IAM ロールを使用する人またはアプリケーション。フェデレーティッドユーザーと引き受けたロールも含まれる。

`※IAMロールとポリシーの違い`

- IAM ロール：「AWS のリソースに付与するもの」で、実態は IAM ポリシーをグルーピングしたもの
- IAM ポリシー：「AWS リソースにアクセスするための権限設定」で、AWS が最初から用意してくれている

ポリシーはロールに内包されているものであり、ロールは AWS リソースに付与されるものである。

（例）ある EC2 には一つだけ IAM ロールが付与できるが、そのロールにさまざまなポリシーを付与することで、その EC2 はさまざまな AWS リソースにアクセスすることができるようになる。

## IAM ポリシーの記述例

IAM ポリシーは JSON 形式で AWS リソースへのアクセス権限を設定するドキュメント

```
{
  "Version": "2012-10-17",  # ポリシーの記述言語のバージョン
  "id": "S3-Assess-Policy", # ポリシーの識別子(オプション)
  "Statement": [            # 1つ以上の宣言文。この中にポリシーを記述
    {
      "Sid": "1",           # Statementの識別子
      "Effect": "Allow",    # アクセス権限を許可・拒否で設定
      "Principal": { "AWS": "arm:aws:jam::12345678901" }, # 適用するアカウント・ユーザー・ロールを指定
      "Action": "s3:*",     # 許可または拒否するアクション
      "Resource": [         # アクションの設定対象となるリソースの一覧
        "arn:aws:s3:::test-bucket",
        "arn:aws:s3:::test2-bucket/*"
      ],
      "Condition": {        # ポリシー適用対象を絞るための追加条件(この条件では指定されたIPアドレスを除外)
        "NotIpAddress": {
          "aws:SourceIp": [
            "192.0.2.0/24",
            "203.0.113.0/24"
          ]
        }
      }
    }
  ]
}
```

## IAM 権限のベストプラクティス

- 人間のユーザーが一時的な認証情報を使用して AWS にアクセスするには、ID プロバイダーとのフェデレーションの使用が必要
- AWS にアクセスするには、ワークロードが IAM ロールを使用して一時的な資格情報を使用する必要がある
- 多要素認証（MFA）が必要
- 長期的な認証情報を必要とするユースケースのためにアクセスキーを定期的にローテーションする
- ルートユーザーの認証情報を保護し、日常的なタスクには使用しない
- 最小特権アクセス許可を適用する
- AWS 管理ポリシーに開始と最小特権のアクセス許可への移行
- IAM Access Analyzer を使用して、アクセスアクティビティに基づいて最小特権ポリシーを生成する
- 未使用のユーザー、ロール、アクセス許可、ポリシー、および認証情報を定期的に確認して削除する
- IAM ポリシーで条件を指定して、アクセスをさらに制限する
- IAM Access Analyzer を使用して、リソースへのパブリックアクセスおよびクロスアカウントアクセスを確認する
- IAM Access Analyzer を使用して IAM ポリシーを検証し、安全で機能的なアクセス許可を確保する
- 複数のアカウントにまたがるアクセス許可のガードレールを確立する
- アクセス権限の境界を使用して、アカウント内のアクセス許可の管理を委任する

## IAM ロールの信頼ポリシー

IAM ロールは監査人などに一時的な権限を移譲する際にも利用される。

- IAM ロールの権限移譲操作に特化したポリシー
- 当該の信頼ポリシーを関連づけた IAM ロールが保有する権限を、信頼ポリシーの操作主体である Principal に移譲（を許可）することができる。

## AWS Organizations について

`複数の AWS アカウントを利用している場合に、統合管理を実施することができる。IAMのアクセス管理を大きな組織でも楽に実施できるようにするマネージド型サービス。`

- 複数アカウントの一元管理
  - AWS アカウントをグループ化してポリシーを適用し、一元的に管理する
- 新規アカウント作成管理
  - コンソール/SDK/CLI で AWS アカウントを新規作成して、作成内容をログ管理できる
- 一括請求
  - 複数の AWS アカウントの請求を一括化する
